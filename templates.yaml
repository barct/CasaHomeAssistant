- sensor:
    - name: "Consumo de Gas m³"
      unique_id: "gas_acumulado_para_energy"
      unit_of_measurement: "m³"
      device_class: gas
      state_class: total_increasing
      state: >
        {% set tiempo = states('sensor.tiempo_uso_caldera') | float(0) %}
        {% set consumo = states('input_number.consumo_de_la_caldera') | float(0) %}
        {{ tiempo * consumo * 0.546 }}
- sensor:
    - name: "Consumo de Gas kg"
      unique_id: "gas_acumulado_para_energy_kg"
      unit_of_measurement: "kg"
      device_class: gas
      state_class: total_increasing
      state: >
        {% set tiempo = states('sensor.tiempo_uso_caldera') | float(0) %}
        {% set consumo = states('input_number.consumo_de_la_caldera') | float(0) %}
        {{ tiempo * consumo }}
- sensor:
    - name: "Consumo de Gas %"
      unique_id: "gas_acumulado_para_energy_porc"
      unit_of_measurement: "%"
      device_class: gas
      state_class: total_increasing
      state: >
        {% set tiempo = states('sensor.tiempo_uso_caldera') | float(0) %}
        {% set consumo = states('input_number.consumo_de_la_caldera') | float(0) %}
        {{ (tiempo * consumo) / 4.0 }}

- sensor:
    - name: "Nivel Estimado de Gas"
      unique_id: "gas_nivel_estimado"
      unit_of_measurement: "%"
      device_class: gas
      state_class: total_increasing
      state: >
        {% set tiempo = states('input_number.tiempo_de_uso_caldera_corregido') | float(0) %}
        {% set consumo = states('input_number.consumo_de_la_caldera') | float(0) %}
        {{ (100-(tiempo * consumo) / 4.0) }}

- sensor:
    - name: "Consumo Estimado de Caldera"
      unique_id: "caldera_consumo_estimado"
      unit_of_measurement: "kg/h"
      device_class: gas
      state_class: total_increasing
      state: >
        {% set tiempo = states('sensor.tiempo_uso_caldera_hasta_cambio_nivel') | float(0) %}
        {% set consumo = states('input_number.consumo_de_la_caldera') | float(0) %}
        {% set nivel = states('counter.nivel_de_gas') | float(0) %}
        {{ (400-(nivel * 4)) / tiempo }}

- sensor:
    - name: "Clima Casa Máxima diaria"
      unique_id: clima_casa_maxima_diaria
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
      availability: >
        {{ states('input_number.temp_today_max') not in ['unknown','unavailable','none','','nan'] }}
      state: >
        {{ states('input_number.temp_today_max') | float }}

    - name: "Clima Casa Mínima diaria"
      unique_id: clima_casa_minima_diaria
      unit_of_measurement: "°C"
      device_class: temperature
      state_class: measurement
      availability: >
        {{ states('input_number.temp_today_min') not in ['unknown','unavailable','none','','nan'] }}
      state: >
        {{ states('input_number.temp_today_min') | float }}

- sensor:
    - name: "Próxima Temperatura (1h)"
      unique_id: living_temperature_next
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {{ states('sensor.0xa4c1385656504f9f_temperature') | float
           + states('sensor.caldera_variacion_temp') | float }}

    - name: "Próxima Temperatura Ext.(1h)"
      unique_id: outside_temperature_next
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {{ state_attr('weather.casa_anisacate','temperature') | float
           + states('sensor.gradiente_temperatura_exterior') | float }}

    - name: "Diferencia de Temperatura"
      unique_id: temperature_diff
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {{ state_attr('weather.casa_anisacate','temperature') | float
           - states('sensor.0xa4c1385656504f9f_temperature') | float }}

- cover:
    - name: "Portón"
      unique_id: porton_virtual_01
      device_class: garage
      state: >
        {{ is_state('binary_sensor.0xa4c13836cd3a3a54_contact', 'on') }}
      icon: >
        {% if is_state('binary_sensor.0xa4c13836cd3a3a54_contact', 'on') %}
          mdi:garage-open
        {% else %}
          mdi:garage
        {% endif %}
      open_cover:
        - action: script.abrir_porton
      close_cover:
        - action: script.cerrar_porton
          data:
            entity_id: scene.abrir_porton

